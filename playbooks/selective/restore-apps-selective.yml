# ============================================================================
# File: playbooks/selective/restore-apps-selective.yml
# Restore specific apps only
# Usage: ansible-playbook playbooks/selective/restore-apps-selective.yml -i inventory.ini --limit personal -e "apps_list=raycast,vscode"
# ============================================================================
---
- name: Selective Application Restore
  hosts: all
  become: false
  
  vars_files:
    - ../../vars/app_backups.yml
  
  vars:
    backup_base: "{{ macos_network_base }}/apps"
  
  pre_tasks:
    - name: Check required network volumes are mounted
      include_tasks: ../../tasks/check_network_volumes.yml
      vars:
        required_volumes: "{{ required_network_volumes }}"
      tags: ['always']
  
  tasks:
    - name: Fail if apps_list not provided
      fail:
        msg: "Please provide apps_list variable: -e 'apps_list=raycast,vscode'"
      when: apps_list is not defined
    
    - name: Parse apps list
      set_fact:
        apps_to_restore: "{{ apps_list.split(',') | map('trim') | list }}"
    
    - name: Validate app keys exist
      fail:
        msg: "App '{{ item }}' not found in app_backup_definitions"
      when: item not in app_backup_definitions
      loop: "{{ apps_to_restore }}"
    
    - name: Display restore summary
      debug:
        msg: |
          üì• Restoring {{ apps_to_restore | length }} selected applications
          üìÅ Apps: {{ apps_to_restore | join(', ') }}
          
          ‚ö†Ô∏è  WARNING: This will overwrite existing app settings!
    
#    - name: Confirm restore
#      pause:
#        prompt: "Press ENTER to continue or Ctrl+C to cancel"
#      when: not (auto_confirm | default(false))
    
    - name: Restore applications
      block:
        - name: "Quit app before restore"
          include_tasks: ../../tasks/quit_app.yml
          vars:
            app_name: "{{ app_backup_definitions[item].name }}"
          loop: "{{ apps_to_restore }}"
        
        - name: "Wait for apps to fully quit"
          pause:
            seconds: 2
        
        - name: "Restore app settings"
          include_tasks: ../../tasks/restore_app.yml
          loop: "{{ apps_to_restore }}"
          loop_control:
            loop_var: app_key
            label: "{{ app_backup_definitions[app_key].name }}"