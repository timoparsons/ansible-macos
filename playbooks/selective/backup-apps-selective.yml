# ============================================================================
# File: playbooks/selective/backup-apps-selective.yml
# Backup specific apps only (useful for testing or partial backups)
# Usage: ansible-playbook playbooks/selective/backup-apps-selective.yml -i inventory.ini --limit personal -e "apps_list=raycast,vscode,davinci-resolve"
# ============================================================================
---
- name: Selective Application Backup
  hosts: all
  become: false
  
  vars_files:
    - ../../vars/app_backups.yml
  
  vars:
    backup_timestamp: "{{ ansible_facts['date_time']['iso8601_basic_short'] }}"
    backup_base: "{{ macos_network_base }}/apps"
  
  tasks:
    - name: Fail if apps_list not provided
      fail:
        msg: "Please provide apps_list variable: -e 'apps_list=raycast,vscode'"
      when: apps_list is not defined
    
    - name: Parse apps list
      set_fact:
        apps_to_backup: "{{ apps_list.split(',') | map('trim') | list }}"
    
    - name: Validate app keys exist
      fail:
        msg: "App '{{ item }}' not found in app_backup_definitions"
      when: item not in app_backup_definitions
      loop: "{{ apps_to_backup }}"
    
    - name: Display backup summary
      debug:
        msg: |
          üì¶ Backing up {{ apps_to_backup | length }} selected applications
          üìÅ Apps: {{ apps_to_backup | join(', ') }}
          üéØ Destination: {{ backup_base }}/{{ machine_type }}/
    
    - name: Backup applications
      include_tasks: ../../tasks/backup_app.yml
      loop: "{{ apps_to_backup }}"
      loop_control:
        loop_var: app_key
        label: "{{ app_backup_definitions[app_key].name }}"