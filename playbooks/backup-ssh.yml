# ============================================================================
# File: playbooks/backup-ssh.yml
# Backup SSH keys and config to network volume
# Only backs up from studio machines (where private keys exist)
# Usage: ansible-playbook playbooks/backup-ssh.yml -i inventory.ini --limit studio
# ============================================================================
---
- name: Backup SSH Configuration to Network Volume
  hosts: studio
  become: false
  
  vars:
    backup_base: "{{ macos_network_base }}/ssh/studio"
    backup_timestamp: "{{ ansible_facts['date_time']['iso8601_basic_short'] }}"

  pre_tasks:
    - name: Check required network volumes are mounted
      include_tasks: "{{ repo_root }}/tasks/check_network_volumes.yml"
      vars:
        required_volumes: "{{ required_network_volumes }}"
      tags: ['always']
          
  tasks:
    - name: Verify network volume is mounted
      stat:
        path: "{{ macos_network_base }}"
      register: network_check
      failed_when: not network_check.stat.exists

    - name: Ensure SSH backup directory exists
      file:
        path: "{{ backup_base }}"
        state: directory
        mode: '0700'
    
    - name: Create timestamped backup directory
      file:
        path: "{{ backup_base }}/backups/{{ backup_timestamp }}"
        state: directory
        mode: '0700'
      when: backup_create_timestamped | default(false) | bool
    
    - name: Check which SSH files exist locally
      stat:
        path: "{{ ansible_facts['env']['HOME'] }}/.ssh/{{ item.src }}"
      register: ssh_file_check
      loop: "{{ ssh_files }}"
      loop_control:
        label: "{{ item.src }}"
    
    - name: Create list of existing SSH files
      set_fact:
        existing_ssh_files: "{{ ssh_file_check.results | selectattr('stat.exists') | map(attribute='item') | list }}"
        missing_ssh_files: "{{ ssh_file_check.results | rejectattr('stat.exists') | map(attribute='item') | list }}"
    
    - name: Display missing SSH files
      debug:
        msg: "â­ï¸  Skipping {{ item.src }} - does not exist locally"
      loop: "{{ missing_ssh_files }}"
      loop_control:
        label: "{{ item.src }}"
      when: missing_ssh_files | length > 0
    
    - name: Display backup summary
      debug:
        msg: |
          ğŸ“¦ Backing up SSH files for {{ machine_type }} machine
          ğŸ“ Destination: {{ backup_base }}/
          ğŸ“ Files to backup: {{ existing_ssh_files | length }}
          {% if backup_create_timestamped %}ğŸ•’ Creating timestamped backup: {{ backup_timestamp }}{% endif %}
    
    - name: Backup SSH files to network volume
      copy:
        src: "{{ ansible_facts['env']['HOME'] }}/.ssh/{{ item.src }}"
        dest: "{{ backup_base }}/{{ item.src }}"
        mode: preserve
        backup: no
      loop: "{{ existing_ssh_files }}"
      loop_control:
        label: "{{ item.src }}"
      no_log: true
    
    - name: Timestamped backup of SSH files
      copy:
        src: "{{ backup_base }}/{{ item.src }}"
        dest: "{{ backup_base }}/backups/{{ backup_timestamp }}/{{ item.src }}"
        mode: preserve
      loop: "{{ existing_ssh_files }}"
      loop_control:
        label: "{{ item.src }}"
      when: backup_create_timestamped | default(false) | bool
      no_log: true
    
    - name: Set correct permissions on backed up private keys
      file:
        path: "{{ backup_base }}/{{ item }}"
        mode: '0600'
      loop:
        - id_ed25519
        - id_rsa
        - config
        - authorized_keys
      ignore_errors: yes
    
    - name: Set correct permissions on backed up public keys
      file:
        path: "{{ backup_base }}/{{ item }}"
        mode: '0644'
      loop:
        - id_ed25519.pub
        - id_rsa.pub
      ignore_errors: yes
    
    - name: Display completion message
      debug:
        msg: |
          âœ… SSH backup complete!
          ğŸ“ Location: {{ backup_base }}/
          ğŸ“ Backed up {{ existing_ssh_files | length }} SSH files
          {% if backup_create_timestamped %}
          ğŸ•’ Timestamped backup: {{ backup_base }}/backups/{{ backup_timestamp }}/
          {% endif %}
          
          ğŸ”’ Permissions have been set correctly