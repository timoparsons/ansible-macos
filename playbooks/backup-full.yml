# ============================================================================
# File: playbooks/backup-full.yml
# Backup everything: SSH, apps, dotfiles, and fonts
# Works with any role/machine type
# Usage: ansible-playbook playbooks/backup-full.yml -i inventory.ini --limit studio
# Usage: ansible-playbook playbooks/backup-full.yml -i inventory.ini --limit laptop
# Usage: ansible-playbook playbooks/backup-full.yml -i inventory.ini --limit editor
# ============================================================================
---
- name: Full System Backup
  hosts: all
  become: false

  pre_tasks:
    - name: Check required network volumes are mounted
      include_tasks: "{{ repo_root }}/tasks/check_network_volumes.yml"
      vars:
        required_volumes: "{{ required_network_volumes }}"
      tags: ['always']
    
    - name: Display full backup notice
      debug:
        msg: |
          ðŸ”„ Starting full system backup for {{ machine_type }} machine
          
          This will backup:
            {% if machine_type in ['studio', 'laptop'] %}
            âœ… SSH keys and config (full private + public keys)
            {% else %}
            â­ï¸  SSH keys (skipped - this role only has public keys from studio/laptop)
            {% endif %}
            âœ… Application settings and data
            {% if lookup('vars', machine_type + '_dotfiles_files', default=[]) | length > 0 %}
            âœ… Dotfiles ({{ lookup('vars', machine_type + '_dotfiles_files', default=[]) | length }} files)
            {% else %}
            â­ï¸  Dotfiles (none configured for this role)
            {% endif %}
            {% if restore_fonts | default(true) and machine_type in ['studio', 'laptop'] %}
            âœ… User fonts
            {% else %}
            â­ï¸  User fonts (skipped for this role)
            {% endif %}
          
          ðŸ“ Destination: {{ macos_network_base }}/
      tags: ['always']

# ============================================================================
# BACKUP SSH (only for studio and laptop - they have private keys)
# ============================================================================
- name: Backup SSH Configuration
  import_playbook: backup-ssh.yml
  tags: ['ssh']

# ============================================================================
# BACKUP APPLICATIONS (all roles)
# ============================================================================
- name: Backup Application Settings
  import_playbook: backup-apps.yml
  tags: ['apps']

# ============================================================================
# BACKUP DOTFILES (roles that have dotfiles configured)
# ============================================================================
- name: Backup Dotfiles
  import_playbook: backup-dotfiles.yml
  tags: ['dotfiles']

# ============================================================================
# COMPLETION MESSAGE
# ============================================================================
- name: Display Completion Summary
  hosts: all
  become: false
  
  tasks:
    - name: Completion message
      debug:
        msg: |
          âœ… Full backup complete for {{ machine_type }} machine!
          
          ðŸ“¦ Backed up:
          {% if machine_type in ['studio', 'laptop'] %}
            âœ… SSH keys â†’ {{ macos_network_base }}/ssh/{{ machine_type }}/
          {% endif %}
            âœ… Applications â†’ {{ macos_network_base }}/apps/
          {% if lookup('vars', machine_type + '_dotfiles_files', default=[]) | length > 0 %}
            âœ… Dotfiles â†’ {{ macos_network_base }}/dotfiles/{{ machine_type }}/
          {% endif %}
          {% if machine_type in ['studio', 'laptop'] %}
            âœ… Fonts â†’ {{ macos_network_base }}/fonts/
          {% endif %}
          
          ðŸ’¡ To restore on another machine:
             ansible-playbook playbooks/restore-ssh.yml -i inventory.ini --limit {{ machine_type }}
             ansible-playbook playbooks/restore-apps.yml -i inventory.ini --limit {{ machine_type }}
             ansible-playbook playbooks/restore-dotfiles.yml -i inventory.ini --limit {{ machine_type }}
             ansible-playbook playbooks/restore-fonts.yml -i inventory.ini --limit {{ machine_type }}
      tags: ['always']