# ============================================================================
# File: playbooks/restore-apps.yml
# Master playbook to restore application settings
# Usage: ansible-playbook playbooks/restore-apps.yml -i inventory.ini --limit personal
# ============================================================================
---
- name: Restore Application Settings
  hosts: all
  become: false
  
  vars_files:
    - ../vars/app_backups.yml
  
  vars:
    backup_base: "{{ macos_network_base }}/apps"
    apps_to_restore: "{{ lookup('vars', machine_type + '_apps_to_backup', default=[]) }}"

  pre_tasks:
    - name: Check required network volumes are mounted
      include_tasks: "{{ playbook_dir }}/tasks/check_network_volumes.yml"
      vars:
        required_volumes: "{{ required_network_volumes }}"
      tags: ['always']
          
  tasks:
    - name: Verify backup exists
      stat:
        path: "{{ backup_base }}"
      register: backup_check
      failed_when: not backup_check.stat.exists
    
    - name: Display restore summary
      debug:
        msg: |
          üì• Restoring {{ apps_to_restore | length }} applications
          üìÅ Source: {{ backup_base }}/
          
          ‚ö†Ô∏è  WARNING: This will overwrite existing app settings!
    
    - name: Confirm restore
      pause:
        prompt: "Press ENTER to continue or Ctrl+C to cancel"
      when: not (auto_confirm | default(false))
    
    - name: Quit all apps before restore
      include_tasks: ../tasks/quit_app.yml
      vars:
        app_name: "{{ app_backup_definitions[item].name }}"
      loop: "{{ apps_to_restore }}"
      loop_control:
        label: "{{ app_backup_definitions[item].name }}"
    
    - name: Wait for apps to fully quit
      pause:
        seconds: 3
        prompt: "Waiting for apps to close..."
    
    - name: Restore applications
      include_tasks: ../tasks/restore_app.yml
      loop: "{{ apps_to_restore }}"
      loop_control:
        loop_var: app_key
        label: "{{ app_backup_definitions[app_key].name }}"