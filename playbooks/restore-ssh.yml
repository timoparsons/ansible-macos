# ============================================================================
# File: playbooks/restore-ssh.yml
# Restore SSH keys and config from network volume
# Respects machine-specific ssh_files configuration
# Usage: ansible-playbook playbooks/restore-ssh.yml -i inventory.ini --limit personal
# ============================================================================
---
- name: Restore SSH Configuration from Network Volume
  hosts: all
  become: false
  
  vars:
    ssh_backup_base: "{{ macos_network_base }}/ssh/{{ machine_type }}"
    ssh_dest_dir: "{{ ansible_facts['env']['HOME'] }}/.ssh"
  
  tasks:
    - name: Verify network volume is mounted
      stat:
        path: "{{ macos_network_base }}"
      register: network_check
      failed_when: not network_check.stat.exists

    - name: Ensure local .ssh directory exists with correct permissions
      file:
        path: "{{ ssh_dest_dir }}"
        state: directory
        mode: '0700'

    - name: Check for SSH backup on network
      stat:
        path: "{{ ssh_backup_base }}"
      register: ssh_backup_check

    - name: Fail if no SSH backup found
      fail:
        msg: "âŒ No SSH backup found at {{ ssh_backup_base }}"
      when: not ssh_backup_check.stat.exists

    - name: Get SSH files to restore for this machine type
      set_fact:
        files_to_restore: "{{ ssh_files | default([]) }}"
    
    - name: Display restore summary
      debug:
        msg: |
          ğŸ“¥ Restoring SSH files for {{ machine_type }} machine
          ğŸ“‚ Source: {{ ssh_backup_base }}/
          ğŸ“ Files to restore: {{ files_to_restore | length }}
          {% if machine_type == 'personal' %}
          ğŸ”‘ Restoring full SSH keys (private + public)
          {% else %}
          ğŸ”“ Restoring public keys only (for SSH host mode)
          {% endif %}
    
    - name: Check which backup files exist
      stat:
        path: "{{ ssh_backup_base }}/{{ item.src }}"
      register: backup_file_check
      loop: "{{ files_to_restore }}"
      loop_control:
        label: "{{ item.src }}"
      when: files_to_restore | length > 0
    
    - name: Create list of restorable files
      set_fact:
        restorable_files: "{{ backup_file_check.results | selectattr('stat.exists') | map(attribute='item') | list }}"
        missing_backups: "{{ backup_file_check.results | rejectattr('stat.exists') | map(attribute='item') | list }}"
      when: files_to_restore | length > 0
    
    - name: Display missing backups
      debug:
        msg: "âš ï¸  Warning: Backup for {{ item.src }} not found"
      loop: "{{ missing_backups }}"
      loop_control:
        label: "{{ item.src }}"
      when: 
        - files_to_restore | length > 0
        - missing_backups | length > 0

    - name: Restore SSH files
      copy:
        src: "{{ ssh_backup_base }}/{{ item.src }}"
        dest: "{{ ssh_dest_dir }}/{{ item.dest }}"
        mode: "{{ item.mode }}"
        backup: yes
      loop: "{{ restorable_files }}"
      loop_control:
        label: "{{ item.dest }}"
      when: restorable_files | length > 0
      no_log: true
      
    - name: Display completion message
      debug:
        msg: |
          âœ… SSH restoration complete!
          ğŸ“ Restored {{ restorable_files | default([]) | length }} files to {{ ssh_dest_dir }}/
          ğŸ”’ Permissions have been set correctly