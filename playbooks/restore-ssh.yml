---
# ============================================================================
# File: playbooks/restore-ssh.yml
# Restore SSH keys from compressed backup
# All roles restore from the same backup - ssh_files in group_vars controls
# which files get applied (full keys for studio/laptop, public only for others)
# Usage: ansible-playbook playbooks/restore-ssh.yml -i inventory.ini --limit studio
# Usage: ansible-playbook playbooks/restore-ssh.yml -i inventory.ini --limit family
# ============================================================================

- name: Restore SSH Configuration from Network Volume
  hosts: all
  become: false

  vars:
    backup_base: "{{ macos_network_base }}/ssh"

  pre_tasks:
    - name: Check required network volumes are mounted
      include_tasks: "{{ repo_root }}/tasks/check_network_volumes.yml"
      vars:
        required_volumes: "{{ required_network_volumes }}"
      tags: ['always']

  tasks:
    - name: Determine if restoring private keys
      set_fact:
        has_private_keys: "{{ ssh_files | selectattr('is_private_key', 'defined') | selectattr('is_private_key') | list | length > 0 }}"

    - name: Display restore summary
      debug:
        msg: |
          üì• Restoring SSH files for {{ machine_type }} machine
          üìÇ Source: {{ backup_base }}/
          üìù Files to restore: {{ ssh_files | length }}
          {{ 'üîë Restoring full SSH keys (private + public)' if has_private_keys else 'üîì Restoring public keys only' }}

    # ========================================================================
    # FIND LATEST BACKUP
    # ========================================================================

    - name: Find latest backup
      shell: |
        ls -t "{{ backup_base }}"/ssh-*.tar.zst 2>/dev/null | head -n 1
      register: latest_backup_check
      changed_when: false
      failed_when: false

    - name: Set backup archive path
      set_fact:
        backup_archive: "{{ latest_backup_check.stdout }}"
      when: latest_backup_check.stdout != ""

    - name: Fail if no backup found
      fail:
        msg: |
          ‚ùå No SSH backup found
          
          Expected format: {{ backup_base }}/ssh-YYYYMMDD.tar.zst
          
          Available files:
          {{ lookup('pipe', 'ls -1 ' + backup_base + '/*.tar.zst 2>/dev/null || echo "  None found"') }}
      when: latest_backup_check.stdout == ""

    # ========================================================================
    # RESTORE PROCESS
    # ========================================================================

    - name: Restore SSH keys
      when: backup_archive is defined
      block:
        - name: Generate unique temp dir
          set_fact:
            temp_extract_dir: "/tmp/ansible-restore-ssh-{{ ansible_date_time.epoch }}"

        - name: Ensure .ssh directory exists
          file:
            path: "{{ ansible_facts['env']['HOME'] }}/.ssh"
            state: directory
            mode: '0700'

        - name: Create temp extraction directory
          file:
            path: "{{ temp_extract_dir }}"
            state: directory
            mode: '0700'

        - name: Extract backup archive
          shell: |
            zstd -d -c "{{ backup_archive }}" | tar -xf - -C "{{ temp_extract_dir }}"
          changed_when: true

        - name: Check for manifest
          stat:
            path: "{{ temp_extract_dir }}/manifest.json"
          register: manifest_check

        # ====================================================================
        # MANIFEST-BASED RESTORE
        # ====================================================================

        - name: Restore using manifest
          when: manifest_check.stat.exists
          block:
            - name: Read manifest
              slurp:
                src: "{{ temp_extract_dir }}/manifest.json"
              register: manifest_raw

            - name: Parse manifest
              set_fact:
                manifest: "{{ manifest_raw.content | b64decode | from_json }}"

            - name: Filter manifest to files defined for this machine
              set_fact:
                filtered_manifest_paths: "{{ manifest.paths | selectattr('dest', 'in', (ssh_files | map(attribute='src') | list)) | list }}"

            - name: Display filtered files
              debug:
                msg: |
                  üìã Filtered for {{ machine_type }}:
                    ‚Ä¢ Available in backup: {{ manifest.paths | length }}
                    ‚Ä¢ Will restore: {{ filtered_manifest_paths | length }}
                    ‚Ä¢ Skipping: {{ manifest.paths | length - filtered_manifest_paths | length }}

            - name: Restore each SSH file
              include_tasks: ../tasks/restore_ssh_file_from_manifest.yml
              loop: "{{ filtered_manifest_paths }}"
              loop_control:
                loop_var: path_item
                label: "{{ path_item.dest }}"
              vars:
                source_dir: "{{ temp_extract_dir }}"

        # ====================================================================
        # FALLBACK: LEGACY RESTORE
        # ====================================================================

        - name: Legacy restore without manifest
          when: not manifest_check.stat.exists
          block:
            - name: Warn about legacy restore
              debug:
                msg: "‚ö†Ô∏è  No manifest found - using legacy restore method"

            - name: Restore SSH files using definition
              include_tasks: ../tasks/restore_ssh_file_legacy.yml
              loop: "{{ ssh_files }}"
              loop_control:
                loop_var: ssh_item
                label: "{{ ssh_item.dest }}"
              vars:
                source_dir: "{{ temp_extract_dir }}"

        # ====================================================================
        # PERMISSIONS
        # ====================================================================

        - name: Ensure correct permissions on .ssh directory
          file:
            path: "{{ ansible_facts['env']['HOME'] }}/.ssh"
            state: directory
            mode: '0700'
            recurse: yes

        # ====================================================================
        # COMPLETION
        # ====================================================================

        - name: Display completion message
          debug:
            msg: |
              ‚úÖ SSH keys restored!
              üì¶ From: {{ backup_archive | basename }}
              üîÑ Method: {{ 'Manifest-based' if manifest_check.stat.exists else 'Legacy' }}
              üìù Restored: {{ filtered_manifest_paths | default(ssh_files) | length }} files
              üîí Permissions set correctly

      always:
        - name: Cleanup temp extraction directory
          file:
            path: "{{ temp_extract_dir }}"
            state: absent
          failed_when: false