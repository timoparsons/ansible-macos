# playbooks/backup-apps.yml
---
# ============================================================================
# Backup all apps for current machine type
# Creates: appname-role-YYYYMMDD.tar.zst
# ============================================================================

- name: Backup Application Settings
  hosts: all
  become: false
  
  vars_files:
    - ../vars/app_backups.yml
  
  vars:
    backup_base: "{{ macos_network_base }}/apps"
    apps_to_backup: "{{ lookup('vars', machine_type + '_apps_to_backup', default=[]) }}"

  pre_tasks:
    - name: Check required network volumes are mounted
      include_tasks: "{{ repo_root }}/tasks/check_network_volumes.yml"
      vars:
        required_volumes: "{{ required_network_volumes }}"
      tags: ['always']
        
  tasks:
    - name: Display backup summary
      debug:
        msg: |
          ğŸ“¦ Backing up {{ apps_to_backup | length }} applications for {{ machine_type }}
          ğŸ“ Destination: {{ backup_base }}/
          ğŸ“ Format: appname-{{ machine_type }}-{{ ansible_date_time.date }}.tar.zst
    
    - name: Backup each application
      include_tasks: ../tasks/backup_app.yml
      loop: "{{ apps_to_backup }}"
      loop_control:
        loop_var: app_key
        label: "{{ app_backup_definitions[app_key].name }}"