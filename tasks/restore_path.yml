# ============================================================================
# File: tasks/restore_path.yml
# Restores a single path (file or directory)
# Called by restore_app.yml, not run directly
# Supports both user-level (~) and system-level (/Library) paths
# ============================================================================
---
- name: "Expand source path for {{ path_item.src }}"
  set_fact:
    expanded_src: "{{ path_item.src | expanduser }}"

- name: "Determine source type from path"
  set_fact:
    # If src ends with a filename extension or is explicitly a known file, treat as file
    is_file_path: "{{ (expanded_src | basename) is search('\\.[a-zA-Z0-9]+$') }}"

- name: "Build backup path"
  set_fact:
    backup_path: "{{ backup_base }}/{{ path_item.dest }}"

- name: "Check if backup exists: {{ path_item.dest }}"
  stat:
    path: "{{ backup_path }}"
  register: backup_check

- name: "Debug backup check for {{ path_item.dest }}"
  debug:
    msg: |
      Backup path: {{ backup_path }}
      Exists: {{ backup_check.stat.exists }}
      Is file: {{ backup_check.stat.isreg | default(false) }}
      Is directory: {{ backup_check.stat.isdir | default(false) }}
  when: backup_check.stat.exists

- name: "Handle restore based on backup existence"
  block:
    - name: "Detect if restore requires system permissions"
      set_fact:
        needs_sudo: "{{ expanded_src.startswith('/Library') or expanded_src.startswith('/private') }}"
      when: backup_check.stat.exists

    - name: "Restore {{ path_item.dest }}"
      when: backup_check.stat.exists
      block:
        - name: "Ensure parent directory exists for {{ expanded_src }}"
          file:
            path: "{{ expanded_src | dirname }}"
            state: directory
            mode: '0755'
          become: "{{ needs_sudo }}"
          when: (expanded_src | dirname) != expanded_src

        # DECISION TREE:
        # 1. If backup_path is a regular file → restore as file
        # 2. If backup_path is a directory → restore as directory
        
        - name: "Restore file: {{ path_item.src }}"
          copy:
            src: "{{ backup_path }}"
            dest: "{{ expanded_src }}"
            mode: preserve
            backup: yes
          become: "{{ needs_sudo }}"
          when: backup_check.stat.isreg | default(false)

        - name: "Restore directory: {{ path_item.src }}"
          synchronize:
            src: "{{ backup_path }}/"
            dest: "{{ expanded_src }}/"
            recursive: yes
            delete: no
          become: "{{ needs_sudo }}"
          delegate_to: "{{ inventory_hostname }}"
          when: backup_check.stat.isdir | default(false)

    - name: "Warning: Backup not found: {{ path_item.dest }}"
      debug:
        msg: "⚠️  Skipping {{ path_item.dest }} - backup does not exist at {{ backup_path }}"
      when: not backup_check.stat.exists