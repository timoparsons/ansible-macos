---
# tasks/restore_path.yml (just the compressed section)
- name: "Build backup paths"
  set_fact:
    backup_path: "{{ backup_base }}/{{ path_item.dest }}"
    backup_path_compressed_zst: "{{ backup_base }}/{{ path_item.dest }}.tar.zst"
    backup_path_compressed_gz: "{{ backup_base }}/{{ path_item.dest }}.tar.gz"
    backup_path_compressed_zip: "{{ backup_base }}/{{ path_item.dest }}.zip"

- name: "Check for compressed backups"
  stat:
    path: "{{ item }}"
  register: compressed_checks
  loop:
    - "{{ backup_path_compressed_zst }}"
    - "{{ backup_path_compressed_gz }}"
    - "{{ backup_path_compressed_zip }}"

- name: "Determine backup type"
  set_fact:
    backup_compressed_zst: "{{ compressed_checks.results[0].stat.exists }}"
    backup_compressed_gz: "{{ compressed_checks.results[1].stat.exists }}"
    backup_compressed_zip: "{{ compressed_checks.results[2].stat.exists }}"
    is_compressed: "{{ compressed_checks.results | selectattr('stat.exists') | list | length > 0 }}"

# ... existing uncompressed backup check ...

- name: "Restore from compressed backup"
  when: is_compressed
  block:
    - name: "Ensure parent directory exists"
      file:
        path: "{{ expanded_src | dirname }}"
        state: directory
        mode: '0755'
      become: "{{ needs_sudo }}"

    # TAR.ZST (preferred)
    - name: "Extract tar.zst backup"
      shell: |
        zstd -d -c "{{ backup_path_compressed_zst }}" | tar -xf - -C "{{ expanded_src | dirname }}"
      when: backup_compressed_zst
      become: "{{ needs_sudo }}"

    # TAR.GZ (fallback)
    - name: "Extract tar.gz backup"
      unarchive:
        src: "{{ backup_path_compressed_gz }}"
        dest: "{{ expanded_src | dirname }}"
        remote_src: yes
      when: backup_compressed_gz and not backup_compressed_zst
      become: "{{ needs_sudo }}"

    # ZIP (legacy fallback)
    - name: "Extract zip backup"
      unarchive:
        src: "{{ backup_path_compressed_zip }}"
        dest: "{{ expanded_src | dirname }}"
        remote_src: yes
      when: backup_compressed_zip and not backup_compressed_zst and not backup_compressed_gz
      become: "{{ needs_sudo }}"