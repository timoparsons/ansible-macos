# tasks/backup_app.yml
---
# ============================================================================
# File: tasks/backup_app.yml
# Creates: apps/appname/appname-role-YYYYMMDD.tar.zst
# Compression happens locally in /tmp, then moved to network
# Includes manifest.json for intelligent restoration
# ============================================================================
- name: "Reset manifest for {{ app_key }}"
  set_fact:
    manifest_paths: []  # This clears the accumulation from previous apps

- name: "Set app definition for {{ app_key }}"
  set_fact:
    app_def: "{{ app_backup_definitions[app_key] }}"

- name: "Generate backup paths"
  set_fact:
    app_backup_dir: "{{ backup_base }}/{{ app_key }}"
    backup_filename: "{{ app_key }}-{{ machine_type }}-{{ ansible_date_time.date }}.tar.zst"
    temp_dir: "/tmp/ansible-backup-{{ app_key }}-{{ ansible_date_time.epoch }}"

- name: "Set full backup filepaths"
  set_fact:
    # Add epoch here to prevent filename collisions in /tmp
    temp_archive: "/tmp/{{ ansible_date_time.epoch }}-{{ backup_filename }}"
    final_archive: "{{ app_backup_dir }}/{{ backup_filename }}"

- name: "Ensure app backup directory exists on network"
  file:
    path: "{{ app_backup_dir }}"
    state: directory
    mode: '0755'

- name: "Check if today's backup already exists"
  stat:
    path: "{{ final_archive }}"
  register: existing_backup

- name: "Skip if backup exists for today"
  debug:
    msg: "‚è≠Ô∏è  Backup already exists: {{ app_key }}/{{ backup_filename }}"
  when: existing_backup.stat.exists

- name: "Create backup for {{ app_def.name }}"
  when: not existing_backup.stat.exists
  block:
    # ========================================================================
    # 1. CHECK DISK SPACE
    # ========================================================================
    
    - name: "Check available space in /tmp"
      shell: df -k /tmp | tail -1 | awk '{print $4}'
      register: tmp_space
      changed_when: false

    - name: "Warn if low disk space"
      debug:
        msg: "‚ö†Ô∏è  Only {{ (tmp_space.stdout | int / 1024 / 1024) | round(2) }} GB available in /tmp"
      when: (tmp_space.stdout | int) < 5000000

    # ========================================================================
    # 2. CHECK WHICH PATHS EXIST
    # ========================================================================

    - name: "Force cleanup of staging directory before starting"
      file:
        path: "{{ temp_dir }}"
        state: absent

    - name: "Create temp staging directory"
      file:
        path: "{{ temp_dir }}"
        state: directory
        mode: '0755'

    - name: "Check which source paths exist"
      stat:
        path: "{{ item.src | expanduser }}"
      register: path_checks
      loop: "{{ app_def.paths }}"

    - name: "Filter to existing paths only"
      set_fact:
        existing_path_checks: "{{ path_checks.results | selectattr('stat.exists') | list }}"

    - name: "Display paths to backup"
      debug:
        msg: |
          üì¶ Backing up {{ app_def.name }}
          üìÅ Found {{ existing_path_checks | length }}/{{ app_def.paths | length }} paths
          
    - name: "Skip if no paths exist"
      meta: end_host
      when: existing_path_checks | length == 0

    # ========================================================================
    # 3. BUILD MANIFEST DATA
    # ========================================================================
    
    - name: "Build manifest entries"
      set_fact:
        manifest_paths: "{{ manifest_paths | default([]) + [manifest_entry] }}"
      loop: "{{ existing_path_checks }}"
      vars:
        expanded_path: "{{ item.item.src | expanduser }}"
        manifest_entry:
          src: "{{ item.item.src }}"
          dest: "{{ item.item.dest }}"
          type: "{{ 'user_file' if item.stat.isreg and item.item.src.startswith('~') else 'user_directory' if item.stat.isdir and item.item.src.startswith('~') else 'shared_directory' if '/Users/Shared/' in item.item.src else 'system_file' if item.stat.isreg else 'system_directory' }}"
          needs_sudo: "{{ not item.item.src.startswith('~') }}"
          is_file: "{{ item.stat.isreg }}"

    - name: "Create manifest file"
      copy:
        content: |
          {
            "app_key": "{{ app_key }}",
            "app_name": "{{ app_def.name }}",
            "backup_date": "{{ ansible_date_time.date }}",
            "backup_timestamp": "{{ ansible_date_time.iso8601 }}",
            "machine_type": "{{ machine_type }}",
            "manifest_version": "1.0",
            "exclude": {{ app_def.exclude | default([]) | to_json }},
            "paths": {{ manifest_paths | to_json }}
          }
        dest: "{{ temp_dir }}/manifest.json"

    # ========================================================================
    # 4. STAGE FILES TO TEMP DIRECTORY
    # ========================================================================
    
    - name: "Copy paths to staging directory"
      shell: |
        set -e
        SRC="{{ item.src | expanduser }}"
        DEST="{{ temp_dir }}/{{ item.dest }}"
        
        mkdir -p "$(dirname "$DEST")"
        cp -Rp "$SRC" "$DEST"
      loop: "{{ manifest_paths }}"
      loop_control:
        label: "{{ item.src }} ‚Üí {{ item.dest }}"

    - name: "DEBUG - List staged files"
      shell: |
        echo "=== Staged files in {{ temp_dir }} ==="
        find "{{ temp_dir }}" -maxdepth 3 -ls | head -50
      register: debug_staging
      
    - name: "DEBUG - Show staging"
      debug:
        var: debug_staging.stdout_lines

    # ========================================================================
    # 5. COMPRESS LOCALLY
    # ========================================================================
    
    - name: "Build exclude pattern for tar"
      set_fact:
        tar_excludes: "{{ app_def.exclude | default([]) | map('regex_replace', '^(.*)$', '--exclude=\\1') | join(' ') }}"
      when: app_def.exclude is defined and app_def.exclude | length > 0
    
    - name: "Set empty excludes if none defined"
      set_fact:
        tar_excludes: ""
      when: app_def.exclude is not defined or app_def.exclude | length == 0
    
    - name: "DEBUG - Show exclude pattern"
      debug:
        msg: |
          Exclude pattern: {{ tar_excludes }}
          Number of excludes: {{ app_def.exclude | default([]) | length }}

    - name: "Check if zstd is installed"
      command: which zstd
      register: zstd_check
      changed_when: false
      failed_when: false

    - name: "Install zstd if missing"
      community.general.homebrew:
        name: zstd
        state: present
      when: zstd_check.rc != 0

    - name: "Get size before compression"
      shell: du -sk "{{ temp_dir }}" | cut -f1
      register: original_size
      changed_when: false

    - name: "Create compressed archive without wrapper directory"
      shell: |
        cd "{{ temp_dir }}"
        # Use gtar for better compatibility and GNU tar features
        COPYFILE_DISABLE=1 gtar \
          {{ tar_excludes }} \
          --exclude-backups \
          --exclude-vcs \
          --no-xattrs \
          --no-acls \
          -cf - . | \
          zstd -T0 -10 -q -o "{{ temp_archive }}"
      environment:
        COPYFILE_DISABLE: "1"

    - name: "Get compressed size"
      stat:
        path: "{{ temp_archive }}"
      register: compressed_stats

    - name: "Calculate compression ratio"
      set_fact:
        compression_ratio: "{{ ((1 - (compressed_stats.stat.size / (original_size.stdout | int * 1024))) * 100) | round(1) }}"
      when: (original_size.stdout | int) > 0

    # ========================================================================
    # 6. MOVE TO NETWORK LOCATION
    # ========================================================================
    
    - name: "Move archive to network location (single large transfer)"
      command: mv "{{ temp_archive }}" "{{ final_archive }}"
      register: move_result
      changed_when: move_result.rc == 0

    # ========================================================================
    # 7. DISPLAY SUMMARY
    # ========================================================================
    
    - name: "Display backup summary"
      debug:
        msg: |
          ‚úÖ Backup created: {{ app_key }}/{{ backup_filename }}
          üì¶ Original: {{ (original_size.stdout | int / 1024) | round(2) }} MB
          üíæ Compressed: {{ (compressed_stats.stat.size / 1024 / 1024) | round(2) }} MB
          üìâ Saved: {{ compression_ratio | default('N/A') }}%
          üìÅ Location: {{ final_archive }}
          üìã Manifest: Included ({{ manifest_paths | length }} paths)
          üöÄ Method: Local compression ‚Üí Network transfer

  always:
    # ========================================================================
    # 8. CLEANUP
    # ========================================================================
    
    - name: "Cleanup temp staging directory"
      file:
        path: "{{ temp_dir }}"
        state: absent
      failed_when: false

    - name: "Cleanup temp archive if move failed"
      file:
        path: "{{ temp_archive }}"
        state: absent
      failed_when: false
      when: move_result is defined and move_result.rc != 0