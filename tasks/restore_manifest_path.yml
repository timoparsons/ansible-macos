---
# ============================================================================
# File: tasks/restore_manifest_path.yml
# Restores a single path using manifest metadata
# FIXED: Uses path_item.dest (the relative path in backup)
# ADDED: Automatic ownership fix for sudo-restored paths
# ============================================================================

- name: "Expand destination path for {{ path_item.src }}"
  set_fact:
    dest_path: "{{ path_item.src | expanduser }}"
    source_path: "{{ temp_extract_dir }}/{{ path_item.dest }}"

- name: "Check if source exists in backup"
  stat:
    path: "{{ source_path }}"
  register: source_check

- name: "Skip if source not in backup"
  debug:
    msg: "⏭️  Skipping {{ path_item.src }} - not found in backup"
  when: not source_check.stat.exists

# ============================================================================
# RESTORE OPERATIONS
# ============================================================================

- name: "Restore {{ path_item.src }}"
  when: source_check.stat.exists
  block:
    # ========================================================================
    # FILE RESTORATION
    # ========================================================================
    
    - name: "Restore file: {{ path_item.src }}"
      when: path_item.is_file
      block:
        - name: "Create parent directory for file"
          file:
            path: "{{ dest_path | dirname }}"
            state: directory
            mode: '0755'
          become: "{{ path_item.needs_sudo }}"
          when: (dest_path | dirname) != '' and (dest_path | dirname) != '/'

        - name: "Copy file from backup"
          copy:
            src: "{{ source_path }}"
            dest: "{{ dest_path }}"
            mode: preserve
            force: yes
            remote_src: yes
          become: "{{ path_item.needs_sudo }}"
        
        - name: "Fix file ownership after sudo restore"
          file:
            path: "{{ dest_path }}"
            owner: "{{ ansible_user_id }}"
            group: staff
          become: true
          when: path_item.needs_sudo
          failed_when: false

        - name: "Display file restore"
          debug:
            msg: "✅ Restored file: {{ path_item.src }}{{ ' (sudo)' if path_item.needs_sudo else '' }}{{ ' [ownership fixed]' if path_item.needs_sudo else '' }}"

    # ========================================================================
    # DIRECTORY RESTORATION
    # ========================================================================
    
    - name: "Restore directory: {{ path_item.src }}"
      when: not path_item.is_file
      block:
        - name: "Create destination directory"
          file:
            path: "{{ dest_path }}"
            state: directory
            mode: '0755'
          become: "{{ path_item.needs_sudo }}"

        - name: "Sync directory contents (with sudo)"
          shell: |
            rsync -av --no-perms --no-owner --no-group --inplace \
              "{{ source_path }}/" "{{ dest_path }}/" > /tmp/rsync-output-$$.log 2>&1
            echo "Rsync completed for {{ path_item.src }}"
          become: "{{ path_item.needs_sudo }}"
          when: path_item.needs_sudo
          environment:
            LANG: C
            LC_ALL: C
          register: rsync_sudo
          changed_when: true

        - name: "Sync directory contents (without sudo)"
          shell: |
            rsync -av --no-perms --no-owner --no-group --inplace \
              "{{ source_path }}/" "{{ dest_path }}/" > /tmp/rsync-output-$$.log 2>&1
            echo "Rsync completed for {{ path_item.src }}"
          when: not path_item.needs_sudo
          environment:
            LANG: C
            LC_ALL: C
          register: rsync_no_sudo
          changed_when: true
        
        - name: "Fix ownership after sudo restore"
          shell: |
            # Fix ownership to current user for paths we restored with sudo
            chown -R {{ ansible_user_id }}:staff "{{ dest_path }}"
          become: true
          when: path_item.needs_sudo
          failed_when: false

        - name: "Display directory restore"
          debug:
            msg: "✅ Restored directory: {{ path_item.src }}{{ ' (sudo)' if path_item.needs_sudo else '' }}{{ ' [ownership fixed]' if path_item.needs_sudo else '' }}"