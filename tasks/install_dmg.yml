---
# tasks/install_dmg.yml
# Shared task to handle DMG files containing either .app or .pkg installers
# Pass in the variable 'dmg_pkg_apps' when including this task

- name: Process DMG installers
  block:
    - name: Mount DMG
      command: hdiutil attach "{{ item.url }}" -nobrowse -quiet
      register: mount_result
      changed_when: false
      failed_when: mount_result.rc != 0

    - name: Extract mount point from hdiutil output
      set_fact:
        mount_point: "{{ mount_result.stdout_lines | select('search', '/Volumes/') | first | regex_replace('^.*(/Volumes/[^\\s]+).*$', '\\1') }}"

    - name: Check for .app file in DMG
      find:
        paths: "{{ mount_point }}"
        patterns: "*.app"
        file_type: directory
        recurse: no
      register: app_files

    - name: Check for .pkg file in DMG
      find:
        paths: "{{ mount_point }}"
        patterns: "*.pkg"
        file_type: file
        recurse: no
      register: pkg_files

    - name: Install .app from DMG
      block:
        - name: Copy app to Applications folder
          command: cp -R "{{ app_files.files[0].path }}" /Applications/
          args:
            creates: "/Applications/{{ app_files.files[0].path | basename }}"
          become: true
          
        - name: Set correct permissions on app
          file:
            path: "/Applications/{{ app_files.files[0].path | basename }}"
            owner: root
            group: wheel
            mode: '0755'
          become: true
      when: app_files.matched > 0

    - name: Install .pkg from DMG
      block:
        - name: Install PKG with installer
          command: installer -pkg "{{ pkg_files.files[0].path }}" -target /
          become: true
          register: pkg_install
          changed_when: pkg_install.rc == 0
      when: pkg_files.matched > 0

    - name: Warn if no installer found
      debug:
        msg: "WARNING: No .app or .pkg found in {{ mount_point }} for {{ item.name }}"
      when: app_files.matched == 0 and pkg_files.matched == 0

  always:
    - name: Unmount DMG
      command: hdiutil detach "{{ mount_point }}"
      changed_when: false
      failed_when: false
      when: mount_point is defined

  loop: "{{ dmg_pkg_apps }}"
  when: 
    - dmg_pkg_apps is defined 
    - dmg_pkg_apps | length > 0
  loop_control:
    label: "{{ item.name }}"