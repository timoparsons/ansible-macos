---
# tasks/macos_baseline_settings.yml
# Baseline macOS settings applied to all machine types

###############################################################################
# Remote Access
###############################################################################
- name: Check if Remote Login (SSH) is already enabled
  ansible.builtin.shell: |
    sudo launchctl list | grep -q com.openssh.sshd && echo "enabled" || echo "disabled"
  register: ssh_status
  changed_when: false
  failed_when: false

- name: Enable Remote Login (SSH server)
  ansible.builtin.command: launchctl load -w /System/Library/LaunchDaemons/ssh.plist
  become: true
  when: ssh_status.stdout == "disabled"
  register: ssh_enable
  changed_when: ssh_enable.rc == 0
  failed_when: ssh_enable.rc != 0 and ssh_enable.rc != 37  # 37 = already loaded

- name: Display Remote Login status
  debug:
    msg: "{{ '✅ Remote Login enabled' if ssh_status.stdout == 'disabled' else '✅ Remote Login already enabled' }}"
    
###############################################################################
# General UI/UX
###############################################################################
- name: Expand save and print panels by default
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: "{{ item }}"
    type: bool
    value: true
    state: present
  loop:
    - NSNavPanelExpandedStateForSaveMode
    - NSNavPanelExpandedStateForSaveMode2
    - PMPrintingExpandedStateForPrint
    - PMPrintingExpandedStateForPrint2

- name: Save to disk (not iCloud) by default
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: NSDocumentSaveNewDocumentsToCloud
    type: bool
    value: false
    state: present

###############################################################################
# Menu Bar
###############################################################################
- name: Configure menu bar clock
  community.general.osx_defaults:
    domain: com.apple.menuextra.clock
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'ShowDate', type: 'int', value: 1 }

###############################################################################
# Trackpad & Mouse
###############################################################################
- name: Enable tap to click
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { domain: 'com.apple.driver.AppleBluetoothMultitouch.trackpad', key: 'Clicking', type: 'int', value: 1 }
    - { domain: 'NSGlobalDomain', key: 'com.apple.mouse.tapBehavior', type: 'int', value: 1 }

- name: Enable trackpad right-click with two fingers
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: bool
    value: true
    state: present
  loop:
    - { domain: 'com.apple.driver.AppleBluetoothMultitouch.trackpad', key: 'TrackpadRightClick' }
    - { domain: 'com.apple.AppleMultitouchTrackpad', key: 'TrackpadRightClick' }

- name: Enable trackpad right-click gesture
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: ContextMenuGesture
    type: int
    value: 1
    state: present

###############################################################################
# Keyboard & Text
###############################################################################
- name: Disable text substitutions
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: "{{ item }}"
    type: bool
    value: false
    state: present
  loop:
    - NSAutomaticSpellingCorrectionEnabled
    - NSAutomaticQuoteSubstitutionEnabled
    - NSAutomaticDashSubstitutionEnabled
    - NSAutomaticPeriodSubstitutionEnabled

- name: Use F1, F2, etc. as standard function keys
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: com.apple.keyboard.fnState
    type: bool
    value: true
    state: present

###############################################################################
# Finder Settings
###############################################################################
- name: Configure Finder UI elements
  community.general.osx_defaults:
    domain: com.apple.finder
    key: "{{ item.key }}"
    type: "{{ item.type | default('bool') }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'ShowExternalHardDrivesOnDesktop', value: false }
    - { key: 'ShowHardDrivesOnDesktop', value: false }
    - { key: 'ShowMountedServersOnDesktop', value: false }
    - { key: 'ShowRemovableMediaOnDesktop', value: false }
    - { key: 'ShowStatusBar', value: true }
    - { key: 'ShowPathbar', value: true }
    - { key: 'FXEnableExtensionChangeWarning', value: false }
    - { key: 'FXPreferredViewStyle', type: 'string', value: 'clmv' }
    - { key: '_FXSortFoldersFirst', value: true }
    - { key: 'QLEnableTextSelection', value: true }
    - { key: 'FXDefaultSearchScope', type: 'string', value: 'SCcf' }
    - { key: 'NewWindowTarget', type: 'string', value: 'PfDe' }

- name: Enable spring loading for directories
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'com.apple.springing.enabled', type: 'bool', value: true }
    - { key: 'com.apple.springing.delay', type: 'float', value: 0.1 }

- name: Avoid creating .DS_Store files on network volumes
  community.general.osx_defaults:
    domain: com.apple.desktopservices
    key: DSDontWriteNetworkStores
    type: bool
    value: true
    state: present

- name: Show ~/Library folder
  ansible.builtin.command: chflags nohidden ~/Library
  changed_when: false

- name: Show all filename extensions
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleShowAllExtensions
    type: bool
    value: true
    state: present

###############################################################################
# Desktop & Stage Manager
###############################################################################
- name: Disable click wallpaper to reveal desktop
  community.general.osx_defaults:
    domain: com.apple.WindowManager
    key: EnableStandardClickToShowDesktop
    type: bool
    value: false
    state: present

###############################################################################
# Dock & Mission Control
###############################################################################
- name: Configure Dock behavior
  community.general.osx_defaults:
    domain: com.apple.dock
    key: "{{ item.key }}"
    type: "{{ item.type | default('bool') }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'autohide', value: true }
    - { key: 'show-recents', value: false }
    - { key: 'minimize-to-application', value: true }
    - { key: 'mineffect', type: 'string', value: 'scale' }
    - { key: 'expose-animation-duration', type: 'float', value: 0.15 }
    - { key: 'autohide-time-modifier', type: 'float', value: 0.5 }
    - { key: 'showhidden', value: true }

###############################################################################
# Hot Corners
###############################################################################
- name: Set Hot Corners
  community.general.osx_defaults:
    domain: com.apple.dock
    key: "{{ item.key }}"
    type: int
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'wvous-tr-corner', value: 4 }
    - { key: 'wvous-tr-modifier', value: 0 }
    - { key: 'wvous-bl-corner', value: 10 }
    - { key: 'wvous-bl-modifier', value: 0 }

###############################################################################
# Screenshots
###############################################################################
- name: Configure screenshot settings
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: 'location', type: 'string', value: '~/Desktop' }
    - { key: 'type', type: 'string', value: 'png' }
    - { key: 'disable-shadow', type: 'bool', value: true }

###############################################################################
# Photos
###############################################################################
- name: Prevent Photos from opening when devices are plugged in
  community.general.osx_defaults:
    domain: com.apple.ImageCapture
    host: currentHost
    key: disableHotPlug
    type: bool
    value: true
    state: present

###############################################################################
# Safari
###############################################################################
- name: Prevent Safari from auto-opening safe files
  community.general.osx_defaults:
    domain: com.apple.Safari
    key: AutoOpenSafeDownloads
    type: bool
    value: false
    state: present

###############################################################################
# App Store
###############################################################################
- name: Disable in-app rating requests
  community.general.osx_defaults:
    domain: com.apple.appstore
    key: InAppReviewEnabled
    type: int
    value: 0
    state: present