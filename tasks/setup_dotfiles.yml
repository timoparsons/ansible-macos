# tasks/setup_dotfiles.yml
---
- name: Get dotfiles list for this machine type
  set_fact:
    dotfiles_list: "{{ lookup('vars', machine_type + '_dotfiles_files', default=[]) }}"

- name: Check if dotfiles directory exists on network volume
  stat:
    path: "{{ macos_network_base }}/dotfiles/{{ machine_type }}"
  register: dotfiles_check
  when: 
    - macos_network_base is defined
    - dotfiles_list | length > 0

- name: Display dotfiles status
  debug:
    msg: "Dotfiles directory {{ 'found' if dotfiles_check.stat.exists else 'not found' }} at {{ macos_network_base }}/dotfiles/{{ machine_type }}"
  when: 
    - macos_network_base is defined
    - dotfiles_check is defined
    - dotfiles_list | length > 0

- name: Check which dotfiles exist on network volume
  stat:
    path: "{{ macos_network_base }}/dotfiles/{{ machine_type }}/{{ item.src }}"
  register: dotfile_exists_check
  loop: "{{ dotfiles_list }}"
  loop_control:
    label: "{{ item.src }}"
  when:
    - macos_network_base is defined
    - dotfiles_check is defined
    - dotfiles_check.stat is defined
    - dotfiles_check.stat.exists
    - dotfiles_list | length > 0

- name: Create list of available dotfiles
  set_fact:
    available_dotfiles: "{{ dotfile_exists_check.results | selectattr('stat.exists') | map(attribute='item') | list }}"
    missing_dotfiles: "{{ dotfile_exists_check.results | rejectattr('stat.exists') | map(attribute='item') | list }}"
  when:
    - macos_network_base is defined
    - dotfiles_check is defined
    - dotfiles_check.stat is defined
    - dotfiles_check.stat.exists
    - dotfile_exists_check is defined
    - dotfiles_list | length > 0

- name: Display missing dotfiles warning
  debug:
    msg: "⚠️  Skipping {{ item.src }} - not found in backup"
  loop: "{{ missing_dotfiles | default([]) }}"
  loop_control:
    label: "{{ item.src }}"
  when:
    - missing_dotfiles is defined
    - missing_dotfiles | length > 0

- name: Copy dotfiles from network volume
  copy:
    src: "{{ macos_network_base }}/dotfiles/{{ machine_type }}/{{ item.src }}"
    dest: "{{ ansible_facts['env']['HOME'] }}/{{ item.dest }}"
    mode: "{{ item.mode | default('0644') }}"
    backup: yes
  loop: "{{ available_dotfiles | default([]) }}"
  loop_control:
    label: "{{ item.src }}"
  when: 
    - macos_network_base is defined
    - dotfiles_check is defined
    - dotfiles_check.stat is defined
    - dotfiles_check.stat.exists
    - available_dotfiles is defined
    - available_dotfiles | length > 0

- name: No dotfiles configured message
  debug:
    msg: "No dotfiles configured for {{ machine_type }} machine type"
  when: 
    - dotfiles_list | length == 0