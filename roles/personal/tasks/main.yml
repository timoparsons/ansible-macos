---
# roles/personal/tasks/main.yml

- name: Install Caddy Root CA Certificate
  block:
    - name: Check if certificate file exists
      stat:
        path: "/Volumes/backup_proxmox/macos/certificates/caddy-root-ca.crt"
      register: cert_file

    - name: Check if certificate is already trusted
      shell: security dump-trust-settings | grep -q "caddy-root-ca" && echo "installed" || echo "not-installed"
      register: cert_check
      changed_when: false
      failed_when: false
      when: cert_file.stat.exists

    - name: Copy certificate to user directory for manual installation
      copy:
        src: "/Volumes/backup_proxmox/macos/certificates/caddy-root-ca.crt"
        dest: "{{ ansible_facts['env']['HOME'] }}/Desktop/caddy-root-ca.crt"
        mode: '0644'
      when: 
        - cert_file.stat.exists
        - cert_check.stdout == "not-installed"
      register: cert_copied

    - name: Display manual certificate installation instructions
      debug:
        msg: |
          
          âš ï¸  MANUAL ACTION REQUIRED: Install Caddy Root CA Certificate
          
          The certificate has been copied to your Desktop: caddy-root-ca.crt
          
          To install it:
          1. Double-click the certificate file on your Desktop
          2. In the Keychain Access window, select "System" from the dropdown
          3. Click "Add"
          4. Enter your password when prompted
          5. Find the certificate in System keychain, double-click it
          6. Expand "Trust" section
          7. Set "When using this certificate" to "Always Trust"
          8. Close the window and enter your password again
          
          Or run this command manually:
          sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain ~/Desktop/caddy-root-ca.crt
      when: 
        - cert_file.stat.exists
        - cert_check.stdout == "not-installed"

    - name: Certificate already installed
      debug:
        msg: "âœ… Caddy Root CA certificate is already installed"
      when: 
        - cert_file.stat.exists
        - cert_check.stdout == "installed"

    - name: Warning if certificate file not found
      debug:
        msg: "âš ï¸  Caddy Root CA certificate not found at /Volumes/backup_proxmox/macos/certificates/caddy-root-ca.crt - skipping"
      when: not cert_file.stat.exists
  tags: ['certificates']

- name: Install personal formula apps
  community.general.homebrew:
    name: "{{ personal_formula_apps }}"
    state: present
  when: personal_formula_apps is defined and personal_formula_apps | length > 0

- name: Install personal cask apps
  community.general.homebrew_cask:
    name: "{{ personal_cask_apps }}"
    state: present
  when: personal_cask_apps is defined and personal_cask_apps | length > 0

- name: Install personal Mac App Store apps
  community.general.mas:
    id: "{{ item.id }}"
    state: present
  loop: "{{ personal_mas_apps }}"
  when: personal_mas_apps is defined and personal_mas_apps | length > 0

- name: Install personal apps from DMG/PKG files
  include_tasks: "{{ playbook_dir }}/tasks/install_dmg.yml"
  vars:
    dmg_pkg_apps: "{{ personal_dmg_pkg_apps }}"
  when: personal_dmg_pkg_apps is defined and personal_dmg_pkg_apps | length > 0




- name: Display personal apps requiring manual installation
  debug:
    msg: |
      
      =====================================================
      ðŸ“‹ MANUAL INSTALLATION REQUIRED (personal)
      =====================================================
      The following apps need to be installed manually:
      {% for app in personal_manual_installs %}
      
      {{ loop.index }}. {{ app.name }}
         URL: {{ app.url }}
         {% if app.note is defined %}Note: {{ app.note }}{% endif %}
      {% endfor %}
      
      =====================================================
  when: personal_manual_installs is defined and personal_manual_installs | length > 0