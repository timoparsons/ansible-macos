# roles/common/tasks/dock.yml
---
- name: Configure Dock
  when: configure_dock | default(true)
  block:
    - name: Set dock configuration based on machine type
      set_fact:
        dock_apps: "{{ lookup('vars', machine_type + '_dock_apps', default=common_dock_apps) }}"
        dock_folders: "{{ lookup('vars', machine_type + '_dock_folders', default=common_dock_folders) }}"
    
    - name: Check which apps exist
      stat:
        path: "{{ item.path }}"
      loop: "{{ dock_apps | default([]) }}"
      register: app_check
      loop_control:
        label: "{{ item.path }}"
    
    - name: Filter to only existing apps
      set_fact:
        existing_dock_apps: "{{ app_check.results | selectattr('stat.exists') | map(attribute='item') | list }}"
        missing_dock_apps: "{{ app_check.results | rejectattr('stat.exists') | map(attribute='item') | list }}"
    
    - name: Warn about missing apps
      debug:
        msg: "⚠️  Skipping {{ item.path | basename }} - not installed yet"
      loop: "{{ missing_dock_apps }}"
      loop_control:
        label: "{{ item.path }}"
      when: missing_dock_apps | length > 0
    
    - name: Remove all items from Dock
      ansible.builtin.command: dockutil --remove all --no-restart
      register: dock_clear
      changed_when: "'No dock items to remove' not in dock_clear.stderr"
      failed_when: false
      when: dock_clear_all | default(true)

    - name: Add existing applications to Dock
      ansible.builtin.command: >
        dockutil --add "{{ item.path }}"
        {% if item.position is defined %}--position {{ item.position }}{% endif %}
        --no-restart
      loop: "{{ existing_dock_apps }}"
      register: dock_add
      changed_when: "'already exists' not in dock_add.stderr"
      failed_when: false
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Add folders/files to Dock
      ansible.builtin.command: >
        dockutil --add "{{ item.path }}"
        {% if item.view is defined %}--view {{ item.view }}{% endif %}
        {% if item.display is defined %}--display {{ item.display }}{% endif %}
        {% if item.sort is defined %}--sort {{ item.sort }}{% endif %}
        {% if item.position is defined %}--position {{ item.position }}{% endif %}
        --no-restart
      loop: "{{ dock_folders | default([]) }}"
      register: dock_folder_add
      changed_when: "'already exists' not in dock_folder_add.stderr"
      failed_when: false

    - name: Trigger Dock restart via handler
      ansible.builtin.debug:
        msg: "Dock layout changed, notifying handler"
      changed_when: dock_clear is changed or dock_add is changed or dock_folder_add is changed
      notify: Restart Dock