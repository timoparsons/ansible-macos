---
# roles/common/tasks/main.yml

# Install Rosetta for Apple Silicon Machines
- name: Ensure Rosetta 2 is installed on Apple Silicon
  shell: softwareupdate --install-rosetta --agree-to-license
  when: ansible_facts['architecture'] == "arm64"
  args:
    creates: /Library/Apple/usr/share/rosetta/rosetta
  tags: ['always']

- name: Check for Homebrew (Apple Silicon)
  stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_arm
  changed_when: false
  tags: ['always']

- name: Check for Homebrew (Intel)
  stat:
    path: /usr/local/bin/brew
  register: homebrew_intel
  changed_when: false
  tags: ['always']

- name: Fail if Homebrew is not installed
  fail:
    msg: "Homebrew is not installed. Please run bootstrap.sh first."
  when: not homebrew_arm.stat.exists and not homebrew_intel.stat.exists
  tags: ['always']

- name: Update Homebrew
  community.general.homebrew:
    update_homebrew: yes
  tags: ['brew', 'update']

- name: Install common formula apps
  community.general.homebrew:
    name: "{{ common_formula_apps }}"
    state: present
  when: common_formula_apps is defined and common_formula_apps | length > 0
  tags: ['brew', 'formula', 'cli']

- name: Install common cask apps
  community.general.homebrew_cask:
    name: "{{ common_cask_apps }}"
    state: present
  when: common_cask_apps is defined and common_cask_apps | length > 0
  tags: ['brew', 'cask', 'gui']

- name: Install common Mac App Store apps
  community.general.mas:
    id: "{{ item.id }}"
    state: present
  loop: "{{ common_mas_apps }}"
  when: common_mas_apps is defined and common_mas_apps | length > 0
  tags: ['mas', 'gui']

- name: Install common apps from DMG/PKG files
  include_tasks: "{{ playbook_dir }}/tasks/install_single_dmg.yml"
  loop: "{{ common_dmg_pkg_apps }}"
  loop_control:
    loop_var: dmg_item
    label: "{{ dmg_item.name }}"
  when: common_dmg_pkg_apps is defined and common_dmg_pkg_apps | length > 0
  tags: ['dmg', 'gui']

- name: Setup SSH keys
  include_tasks: setup_ssh.yml
  tags: ['ssh', 'config', 'dotfiles']
  when: ssh_files is defined and ssh_files | length > 0

- name: Setup dotfiles
  include_tasks: setup_dotfiles.yml
  tags: ['dotfiles', 'config']
  when: dotfiles_files is defined and dotfiles_files | length > 0
  
# 1. Always apply the global baseline
- name: Apply baseline macOS system defaults
  include_tasks: macos_settings.yml
  tags: ['macos_defaults', 'config', 'system']

# 2. Attempt to apply role-specific overrides
- name: Apply role-specific macOS overrides
  include_tasks: "{{ item }}"
  with_first_found:
    - files:
        - "{{ playbook_dir }}/roles/{{ machine_type }}/tasks/macos_settings.yml"
      skip: true  # If the file isn't there, just move on silently
  tags: ['macos_defaults', 'config', 'system']