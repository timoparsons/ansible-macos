---
# roles/common/tasks/main.yml

# Install Rosetta for Apple Silicon Machines
- name: Ensure Rosetta 2 is installed on Apple Silicon
  shell: softwareupdate --install-rosetta --agree-to-license
  when: ansible_facts['architecture'] == "arm64"
  args:
    creates: /Library/Apple/usr/share/rosetta/rosetta

- name: Check for Homebrew (Apple Silicon)
  stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_arm
  changed_when: false

- name: Check for Homebrew (Intel)
  stat:
    path: /usr/local/bin/brew
  register: homebrew_intel
  changed_when: false

- name: Fail if Homebrew is not installed
  fail:
    msg: "Homebrew is not installed. Please run bootstrap.sh first."
  when: not homebrew_arm.stat.exists and not homebrew_intel.stat.exists

- name: Update Homebrew
  community.general.homebrew:
    update_homebrew: yes

- name: Install common formula apps
  community.general.homebrew:
    name: "{{ common_formula_apps }}"
    state: present
  when: common_formula_apps is defined and common_formula_apps | length > 0

- name: Install common cask apps
  community.general.homebrew_cask:
    name: "{{ common_cask_apps }}"
    state: present
  when: common_cask_apps is defined and common_cask_apps | length > 0

- name: Install common Mac App Store apps
  command: "mas install {{ item.id }}"
  loop: "{{ common_mas_apps }}"
  register: mas_result
  changed_when: "'Installed' in mas_result.stdout"
  failed_when: mas_result.rc != 0 and 'already installed' not in mas_result.stderr
  when: common_mas_apps is defined and common_mas_apps | length > 0