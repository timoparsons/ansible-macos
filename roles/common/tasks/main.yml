---
# roles/common/tasks/main.yml

# Install Rosetta for Apple Silicon Machines
- name: Ensure Rosetta 2 is installed on Apple Silicon
  shell: softwareupdate --install-rosetta --agree-to-license
  when: ansible_facts['architecture'] == "arm64"
  args:
    creates: /Library/Apple/usr/share/rosetta/rosetta

- name: Check for Homebrew (Apple Silicon)
  stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_arm
  changed_when: false

- name: Check for Homebrew (Intel)
  stat:
    path: /usr/local/bin/brew
  register: homebrew_intel
  changed_when: false

- name: Fail if Homebrew is not installed
  fail:
    msg: "Homebrew is not installed. Please run bootstrap.sh first."
  when: not homebrew_arm.stat.exists and not homebrew_intel.stat.exists

- name: Update Homebrew
  community.general.homebrew:
    update_homebrew: yes

- name: Install common formula apps
  community.general.homebrew:
    name: "{{ common_formula_apps }}"
    state: present
  when: common_formula_apps is defined and common_formula_apps | length > 0

- name: Install common cask apps
  community.general.homebrew_cask:
    name: "{{ common_cask_apps }}"
    state: present
  when: common_cask_apps is defined and common_cask_apps | length > 0

- name: Install common Mac App Store apps
  community.general.mas:
    id: "{{ item.id }}"
    state: present
  loop: "{{ common_mas_apps }}"
  when: common_mas_apps is defined and common_mas_apps | length > 0

- name: Install common apps from DMG/PKG files
  include_tasks: "{{ playbook_dir }}/tasks/install_dmg.yml"
  vars:
    dmg_pkg_apps: "{{ common_dmg_pkg_apps }}"
  when: common_dmg_pkg_apps is defined and common_dmg_pkg_apps | length > 0

- name: Display common apps requiring manual installation
  debug:
    msg: |
      
      =====================================================
      ðŸ“‹ MANUAL INSTALLATION REQUIRED (common)
      =====================================================
      The following apps need to be installed manually:
      {% for app in common_manual_installs %}
      
      {{ loop.index }}. {{ app.name }}
         URL: {{ app.url }}
         {% if app.note is defined %}Note: {{ app.note }}{% endif %}
      {% endfor %}
      
      =====================================================
  when: common_manual_installs is defined and common_manual_installs | length > 0

- name: Setup SSH keys
  include_tasks: "{{ role_path }}/tasks/setup_ssh.yml"
  tags: ['ssh']
  when: ssh_files is defined and ssh_files | length > 0

- name: Setup dotfiles
  include_tasks: "{{ role_path }}/tasks/setup_dotfiles.yml"
  tags: ['dotfiles']
  when: dotfiles_files is defined and dotfiles_files | length > 0
  
# Apply macOS defaults - common for all machine types
- name: Apply common macOS system defaults
  ansible.builtin.script: "{{ role_path }}/files/macos-defaults.sh"
  register: macos_defaults_result
  changed_when: "'Please log out' in macos_defaults_result.stdout"
  tags: ['macos_defaults']

# Apply role-specific macOS defaults if they exist
- name: Check if role-specific macOS defaults script exists
  stat:
    path: "{{ playbook_dir }}/roles/{{ machine_type }}/files/macos-defaults.sh"
  register: role_defaults_script
  delegate_to: localhost
  when: machine_type != 'common'

- name: Apply role-specific macOS defaults
  ansible.builtin.script: "{{ playbook_dir }}/roles/{{ machine_type }}/files/macos-defaults.sh"
  register: role_defaults_result
  changed_when: "'Please log out' in role_defaults_result.stdout"
  tags: ['macos_defaults']
  when: 
    - machine_type != 'common'
    - role_defaults_script.stat.exists